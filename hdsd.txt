# Triển khai hạ tầng

**Hạ tầng hệ thống bao gồm các dịch vụ sau:**
- Kubernetes
- MySql
- InfluxDb, telegraf và grafana
- Cụm kafka vs kafka-conect
- Elasticsearch và kibana
- Microservice java application

## Cài đặt dịch vụ Telegraf, influxDB vs Grafana

*Các bước cài đặt telegraf, influxDB, grafana trên ubuntu*

### Cài đặt InfluxDB

1. Cập nhật hệ thống ubuntu:

    ```bash
    sudo apt update && sudo apt upgrade
    ```

2. Thêm kho lưu trữ InfluxData cho ubuntu

    ```bash
    # influxdata-archive_compat.key GPG Fingerprint: 9D539D90D3328DC7D6C8D3B9D8FF8E1F7DF8B07E
    wget -q https://repos.influxdata.com/influxdata-archive_compat.key
    echo '393e8779c89ac8d958f81f942f9ad7fb82a25e133faddaf92e15b16e6ac9ce4c influxdata-archive_compat.key' | sha256sum -c && cat influxdata-archive_compat.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg > /dev/null
    echo 'deb [signed-by=/etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg] https://repos.influxdata.com/debian stable main' | sudo tee /etc/apt/sources.list.d/influxdata.list
    ```

3. Cài đặt InfluxDB:

    ```bash
    sudo apt-get update && sudo apt-get install influxdb
    ```
    
    *Sử dụng influxDB version 1.8*

4. Khởi động và kích hoạt dịch vụ InfluxDB

    ```bash
    sudo systemctl start influxdb
    sudo systemctl enable influxdb
    ```

    *Kích hoạt dịch vụ để khời động influxDB cùng với hệ thống*

5. Kiểm tra trạng thái dịch vụ

   - Influx DB chạy trên cổng mặc định 8086.

   - Lưu trữ data tại thư mục: /var/lib/influxdb/data

    ```bash
    sudo systemctl status influxdb
    ```

6. Tạo user quản trị influxDB
    
   - **Mở CLI của influx DB bằng lệnh sau:**
      ```bash
      influx
      ```
   - **Tạo người dùng quản trị bằng lệnh sau:**
     ```bash
     CREATE USER admin WITH PASSWORD 'yourpassword' WITH ALL PRIVILEGES
     ```
   - **Kích hoạt tính năng xác thực người dùng trên influxDB:**

     Mở tệp cấu hình InfluxDB (**`/etc/influxdb/influxdb.conf`**) và tìm phần **`[http]`**. Thêm hoặc chỉnh sửa dòng **`auth-enabled`** thành **`true`**.
     ```bash
     [http]
     auth-enabled = true
     ```
   - **Khởi động lại dịch vụ InfluxDB:**
     ```bash
     sudo systemctl restart influxdb
     ```
   - **Kiểm tra trạng thái dịch vụ:**
     ```bash
     sudo systemctl status influxdb
     ```

7. Tạo dataBase trên influxDB

   - Sử dụng lệnh **`CREATE DATABASE`** để tạo cơ sở dữ liệu mới. 
   - Ví dụ, để tạo một cơ sở dữ liệu tên là **`mydb`**:

      ```sql
      CREATE DATABASE mydb;
      ```

   - Kiểm tra cơ sở dữ liệu đã tạo:

      ```sql
      SHOW DATABASES;
      ```

### Cài đặt Telegraf

1. Thêm kho lưu trữ InfluxData cho ubuntu tương tự với cài đặt influxDB

    ```bash
    # influxdata-archive_compat.key GPG Fingerprint: 9D539D90D3328DC7D6C8D3B9D8FF8E1F7DF8B07E
    curl -s https://repos.influxdata.com/influxdata-archive_compat.key > influxdata-archive_compat.key
    echo '393e8779c89ac8d958f81f942f9ad7fb82a25e133faddaf92e15b16e6ac9ce4c influxdata-archive_compat.key' | sha256sum -c && cat influxdata-archive_compat.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg > /dev/null
    echo 'deb [signed-by=/etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg] https://repos.influxdata.com/debian stable main' | sudo tee /etc/apt/sources.list.d/influxdata.list
    ```

2. Cài đặt Telegraf

    ```bash
    sudo apt-get update && sudo apt-get install telegraf
    ```

3. Khởi động và kích hoạt dịch vụ Telegraf

    ```bash
    sudo systemctl start telegraf
    sudo systemctl enable telegraf
    ```

4. Kiểm tra trạng thái dịch vụ của telegraf

    ```bash
    sudo systemctl status telegraf
    ```

5. Cấu hình telegraf
    
    Cấu hình telegraf lắng nghe kafka và ghi dữ liệu vào influxDB:
    
    [Xem thêm](https://github.com/influxdata/telegraf/blob/master/plugins/inputs/kafka_consumer/README.md)
    
    ```
    [[inputs.kafka_consumer]]
      ## Kafka brokers.
      brokers = ["13.250.21.7:29092"]
    
      consumer_group = "lpb_telegraf_metrics_consumers"
    
      ## Topics to consume.
      topics = ["LPB.PositionData.Sink"]
    
      name_override  = "LPB_PositionData_Sink"
      data_format = "json"
      tag_keys = ["VehicleName", "IMEI"]
      json_string_fields = ["VehicleName", "IMEI"]
      json_time_key = "TimeStamp"
      json_time_format = "2006-01-02T15:04:05+0700"
      json_timezone = "Asia/Ho_Chi_Minh"
    
      ## SASL authentication credentials.  These settings should typically be used
      ## with TLS encryption enabled
      ## sasl_username = "lpbank"
      ## sasl_password = "lpbank@123"
    
      ## Optional SASL:
      ## one of: OAUTHBEARER, PLAIN, SCRAM-SHA-256, SCRAM-SHA-512, GSSAPI
      ## (defaults to PLAIN)
      ## sasl_mechanism = "PLAIN"
    
    # Configuration for sending metrics to InfluxDB
    [[outputs.influxdb]]
      urls = ["http://localhost:8086"]
      ## HTTP Basic Auth
      username = "lpb"
      password = "lpb@12345"
    
      database = "lpb"
    
      ## If true, no CREATE DATABASE queries will be sent.  Set to true when using
      ## Telegraf with a user without permissions to create databases or when the
      ## database already exists.
      skip_database_creation = true
    ```

### Cài đặt Grafana trên ubuntu

1. Cập nhật hệ thống

    ```bash
    sudo apt update && sudo apt upgrade
    ```

2. Thêm Grafana repository

    ```bash
    sudo apt-get install -y software-properties-common
    wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
    sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
    ```

3. Cài đặt grafana

    ```bash
    sudo apt update
    sudo apt install grafana
    ```

4. Khởi động và kích hoạt dịch vụ Grafana

    ```bash
    sudo systemctl start grafana-server
    sudo systemctl enable grafana-server
    ```

5. Kiểm tra trạng thái dịch vụ

    ```bash
    sudo systemctl status grafana-server
    ```

6. Truy cập Grafana

   - Mở trình duyệt web và truy cập địa chỉ: http://localhost:3000
   - Đăng nhập với tài khoản mặc định:
   - Username: **`admin`**
   - Password: **`admin`**
